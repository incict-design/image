<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>画像共有</title>
<style>
body { font-family: system-ui, -apple-system, "メイリオ", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background:#fafafa; }
header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
#gallery {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-auto-rows: 200px;
  gap: 10px;
  justify-items: center;
  margin-top: 10px;
}
@media (max-width: 480px) { #gallery { grid-template-columns: repeat(2, 1fr); } }
.card {
  width: 110px; height: 150px; border: 1px solid #ddd; border-radius: 8px;
  padding: 4px; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; position: relative;
}
.card img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; transition: transform 0.3s; }
.card img:hover { transform: scale(1.05); }
.meta { font-size: 12px; color: #555; margin-top: 4px; white-space: pre-line; text-align: center; }
button { cursor: pointer; padding: 6px 10px; border-radius: 6px; border: 1px solid #bbb; background: #f7f7f7; }
.upload-row { display: flex; gap: 6px; align-items: center; margin-top: 4px; }
.upload-row button { height: 32px; }
#status { font-size: 13px; color: #333; margin-left:8px; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
#overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000;
}
#overlay img { max-width: 90%; max-height: 90%; border-radius: 8px; cursor: pointer; }
.auth { margin-top: 18px; padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #fff; }
.auth-header { display: flex; align-items: center; gap: 8px; }
.auth-row { display: flex; gap: 10px; margin-top: 8px; }
.auth-row input { padding: 6px 8px; border-radius: 6px; border: 1px solid #ddd; }
#authStatus { font-size: 14px; color: #333; }
</style>
</head>
<body>

<header>
  <h1>画廊SHION</h1>
  <div style="margin-left:auto;"></div>
</header>

<section>
  <div id="gallery"></div>
  <div class="upload-row">
    <input id="fileInput" type="file" accept="image/*" style="display:none;">
    <button id="selectBtn">ファイルを選択</button>
    <button id="uploadBtn">アップロード</button>
    <span id="status"></span>
  </div>
</section>

<!-- アカウント -->
<section class="auth">
  <div class="auth-header">
    <h3 style="margin:0;">アカウント</h3>
    <div id="authStatus">未ログイン</div>
    <button id="loginBtn">ログイン</button>
    <button id="logoutBtn" style="display:none;">ログアウト</button>
  </div>

  <div class="auth-row">
    <input id="email" type="email" placeholder="icj21/ich24....@s.icc.ac.jp">
    <input id="password" type="password" placeholder="パスワード：情報教室">
  </div>
</section>

<div id="overlay">
  <img id="overlayImg" src="">
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
// Firebase初期化
const firebaseConfig = {
  apiKey: "AIzaSyCzDqI2YaOLoU4muurvvxBs4fOOSkH8Yew",
  authDomain: "image-share-89916.firebaseapp.com",
  projectId: "image-share-89916",
  storageBucket: "image-share-89916.firebasestorage.app",
  messagingSenderId: "859639070035",
  appId: "1:859639070035:web:aab7543659c3d1a877f5a6"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const authStatus = document.getElementById("authStatus");
const gallery = document.getElementById("gallery");
const status = document.getElementById("status");
const fileInput = document.getElementById("fileInput");
const selectBtn = document.getElementById("selectBtn");
const uploadBtn = document.getElementById("uploadBtn");
const overlay = document.getElementById("overlay");
const overlayImg = document.getElementById("overlayImg");

let selectedFile = null;

// 認証状態変更
auth.onAuthStateChanged(user => {
  if (user) {
    authStatus.textContent = `ログイン中: ${user.displayName || user.email}`;
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
  } else {
    authStatus.textContent = "未ログイン";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  }
});

// ログイン
loginBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const pass = passwordInput.value;
  if (!email || !pass) return alert("メールとパスワードを入力してください");
  try {
    const user = await auth.signInWithEmailAndPassword(email, pass);
    if (!user.user.emailVerified) {
      alert("メール認証が完了していません");
      await auth.signOut();
    }
  } catch (e) {
    alert(e.message);
  }
});

// ログアウト
logoutBtn.addEventListener("click", () => auth.signOut());

// ファイル選択ボタン
selectBtn.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change', () => {
  selectedFile = fileInput.files[0] || null;
  status.textContent = selectedFile ? selectedFile.name : '';
});

// アップロード
uploadBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user || !user.emailVerified) {
    status.textContent = "ログインが必要です";
    return;
  }

  if (!selectedFile) return; // 未選択時は何もしない

  uploadBtn.disabled = true;
  status.textContent = "アップロード中...";
  try {
    const ref = storage.ref(`test-images/${user.uid}`);
    await ref.put(selectedFile);
    const url = await ref.getDownloadURL();
    await db.collection("test-images").doc(user.uid).set({
      username: user.displayName || user.email,
      url,
      updatedAt: new Date()
    });
    status.textContent = "";
    selectedFile = null;
    fileInput.value = ""; // inputをリセット
  } catch (e) {
    status.textContent = "アップロード失敗";
  } finally {
    uploadBtn.disabled = false;
  }
});

// ギャラリー表示
db.collection("test-images").onSnapshot(snapshot => {
  gallery.innerHTML = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const div = document.createElement("div");
    div.className = "card";
    
    const imgEl = document.createElement("img");
    imgEl.src = data.url;
    imgEl.addEventListener("click", () => {
      overlayImg.src = data.url;
      overlay.style.display = "flex";
    });
    
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${data.username}\n${new Date(data.updatedAt.seconds * 1000).toLocaleString()}`;
    
    div.appendChild(imgEl);
    div.appendChild(meta);
    gallery.appendChild(div);
  });
});

overlay.addEventListener("click", () => {
  overlay.style.display = "none";
  overlayImg.src = "";
});
</script>
</body>
</html>
